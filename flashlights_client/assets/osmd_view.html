
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <title>OSMD Practice View</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        background-color: #f1f3f6;
        overflow: hidden;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }

      #osmd {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        background-color: #f1f3f6;
        border-radius: 12px;
        box-sizing: border-box;
        padding: 12px;
      }

      #osmd svg {
        width: auto !important;
        height: auto !important;
        max-width: 100% !important;
        max-height: 100% !important;
      }

      #osmd canvas {
        width: auto !important;
        height: auto !important;
        max-width: 100% !important;
        max-height: 100% !important;
      }

      #osmd svg * {
        fill: #000000 !important;
        stroke: #000000 !important;
      }

      #osmd svg text {
        fill: #000000 !important;
      }

      #osmd svg [fill="none"] {
        stroke: #000000 !important;
      }

      #osmd svg [stroke="none"] {
        fill: #000000 !important;
      }

      #osmd svg [style*="#0C7F79"],
      #osmd svg [style*="#0c7f79"],
      #osmd svg [fill="#0C7F79"],
      #osmd svg [fill="#0c7f79"],
      #osmd svg [data-primer-highlight="true"] {
        fill: #0C7F79 !important;
        stroke: #95FFE3 !important;
        filter:
          drop-shadow(0 0 4px rgba(149, 255, 227, 0.75))
          drop-shadow(0 0 9px rgba(111, 255, 211, 0.45));
      }
    </style>
    <script src="opensheetmusicdisplay.min.js"></script>
  </head>
  <body>
    <div id="osmd" class="osmd-auto-width"></div>
    <script>
      let osmd;

      function postToFlutter(message) {
        try {
          const payload = typeof message === 'string' ? message : JSON.stringify(message);
          if (window.FlutterOSMD && window.FlutterOSMD.postMessage) {
            window.FlutterOSMD.postMessage(payload);
          }
        } catch (err) {
          console.error('postToFlutter failed', err);
        }
      }

      function countSystems(svg) {
        if (!svg) {
          return 0;
        }
        const systems = svg.querySelectorAll('g.system');
        if (systems.length > 0) {
          return systems.length;
        }
        return svg.querySelectorAll('g[id^="System"]').length;
      }

      function getContentBox(element) {
        try {
          const box = element.getBBox();
          if (box && Number.isFinite(box.width) && box.width > 0 && Number.isFinite(box.height) && box.height > 0) {
            return { width: box.width, height: box.height };
          }
        } catch (_) {}
        const rect = element.getBoundingClientRect();
        return {
          width: rect?.width && rect.width > 0 ? rect.width : 1200,
          height: rect?.height && rect.height > 0 ? rect.height : 320,
        };
      }

      function makeSvgResponsive(svg, width, height) {
        if (!width || !height) {
          return;
        }
        svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
        svg.removeAttribute('width');
        svg.removeAttribute('height');
        svg.style.width = '100%';
        svg.style.height = 'auto';
      }

      function applySingleLineRules() {
        if (!osmd || !osmd.EngravingRules) {
          return;
        }
        const rules = osmd.EngravingRules;
        rules.RenderSingleHorizontalLine = true;
        if (Object.prototype.hasOwnProperty.call(rules, 'RenderSingleHorizontalStaffline')) {
          rules.RenderSingleHorizontalStaffline = true;
        }
        if (Object.prototype.hasOwnProperty.call(rules, 'RenderXMeasuresPerLineAkaSystem')) {
          rules.RenderXMeasuresPerLineAkaSystem = 3;
        }
        if (Object.prototype.hasOwnProperty.call(rules, 'LastSystemMaxScalingFactor')) {
          rules.LastSystemMaxScalingFactor = 1;
        }
        if (Object.prototype.hasOwnProperty.call(rules, 'NewSystemFromXML')) {
          rules.NewSystemFromXML = false;
        }
        if (Object.prototype.hasOwnProperty.call(rules, 'PageWidth')) {
          rules.PageWidth = 4200;
        }
        if (Object.prototype.hasOwnProperty.call(rules, 'PageLeftMargin')) {
          rules.PageLeftMargin = 0;
        }
        if (Object.prototype.hasOwnProperty.call(rules, 'PageRightMargin')) {
          rules.PageRightMargin = 0;
        }
      }

      window.onerror = function(message, source, lineno, colno, error) {
        postToFlutter({ type: 'error', message, source, lineno, colno, detail: error ? String(error.stack || error) : null });
      };

      async function initOSMD(xmlString) {
        if (typeof opensheetmusicdisplay === 'undefined') {
          postToFlutter({ type: 'error', phase: 'init', detail: 'opensheetmusicdisplay bundle unavailable' });
          return;
        }
        if (!osmd) {
          try {
            osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay('osmd', {
              backend: 'svg',
              autoResize: false,
              drawTitle: false,
              drawSubtitle: false,
              drawPartNames: false,
              drawingParameters: 'compacttight',
              renderSingleHorizontalLine: true,
              newSystemFromXML: false,
            });
          } catch (err) {
            console.error('OSMD ctor failed', err);
            postToFlutter({ type: 'error', phase: 'ctor', detail: String(err && err.stack ? err.stack : err) });
            return;
          }
        }

        try {
          await osmd.load(xmlString);
          applySingleLineRules();
          osmd.zoom = 0.6;
          await renderWindow(1);
          postToFlutter('ready');
        } catch (err) {
          console.error('OSMD load failed', err);
          postToFlutter({ type: 'error', phase: 'load', detail: String(err && err.stack ? err.stack : err) });
        }
      }

      async function renderWindow(measureNumber) {
        if (!osmd) {
          return;
        }
        try {
          let from = Math.max(1, measureNumber - 1);
          let to = measureNumber + 1;
          if (to - from < 2) {
            to = from + 2;
          }
          if (osmd.sheet && osmd.sheet.SourceMeasures && osmd.sheet.SourceMeasures.length) {
            const maxMeasure = osmd.sheet.SourceMeasures.length;
            if (to > maxMeasure) {
              to = maxMeasure;
              from = Math.max(1, to - 2);
            }
          }

          let zoom = 0.6;
          for (let attempt = 0; attempt < 6; attempt += 1) {
            osmd.setOptions({
              drawFromMeasureNumber: from,
              drawUpToMeasureNumber: to,
              renderSingleHorizontalLine: true,
              newSystemFromXML: false,
            });
            osmd.zoom = zoom;
            applySingleLineRules();
            await osmd.render();

            const container = document.getElementById('osmd');
            const svg = container ? container.querySelector('svg') : null;
            const systems = countSystems(svg);
            if (svg) {
              const box = getContentBox(svg);
              makeSvgResponsive(svg, box.width, box.height);
              container.style.minHeight = `${Math.max(box.height, 140)}px`;
            }

            if (systems <= 1) {
              break;
            }

            zoom *= 0.85;
          }

          postToFlutter({ type: 'window-rendered', from, to });
        } catch (err) {
          console.error('OSMD render failed', err);
          postToFlutter({ type: 'error', phase: 'render', detail: String(err && err.stack ? err.stack : err) });
        }
      }

      function handleMessage(event) {
        if (!event || !event.data) {
          return;
        }

        let message;
        try {
          message = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
        } catch (err) {
          console.error('Unable to parse message', err);
          return;
        }

        if (message?.type === 'init' && message.xml) {
          initOSMD(message.xml);
        } else if (message?.type === 'window' && typeof message.measure === 'number') {
          renderWindow(message.measure);
        }
      }

      window.addEventListener('message', handleMessage);
      window.handleFlutterMessage = handleMessage;
    </script>    </script>
  </body>
</html>
